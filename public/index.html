<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Socket.io Test</title>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  </head>
  <body>
    <h1>Socket.io Client Test</h1>
    <div>
      <input id="userIdInput" type="text" placeholder="Enter User ID" />
      <button onclick="connect()">Connect</button>
    </div>
    <div>
      <input
        id="messageInput"
        type="text"
        placeholder="Type a message..."
        disabled
      />
      <button onclick="sendMessage()" disabled>Send</button>
    </div>
    <div id="messages"></div>

    <script>
      let socket;

      function connect() {
        const userId = document.getElementById("userIdInput").value;
        if (!userId) {
          alert("Please enter a User ID");
          return;
        }

        // Build the WebSocket URL based on the current location
        const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
        const host = window.location.host;
        const wsUrl = `${protocol}//${host}/ws/${encodeURIComponent(userId)}`;

        // Initialize the Socket.io connection
        socket = io(wsUrl, {
          transports: ["websocket"],
        });

        // Socket.io event handlers
        socket.on("connect", () => {
          console.log("Connected to server");

          // Disable user ID input and connect button
          document.getElementById("userIdInput").disabled = true;
          document.querySelector('button[onclick="connect()"]').disabled = true;

          // Enable message input and send button
          document.getElementById("messageInput").disabled = false;
          document.querySelector(
            'button[onclick="sendMessage()"]'
          ).disabled = false;
        });

        socket.on("message", (data) => {
          const messagesDiv = document.getElementById("messages");
          const messageElement = document.createElement("div");
          messageElement.textContent = "Server: " + data;
          messagesDiv.appendChild(messageElement);
        });

        socket.on("disconnect", () => {
          console.log("Disconnected from server");

          // Re-enable user ID input and connect button
          document.getElementById("userIdInput").disabled = false;
          document.querySelector(
            'button[onclick="connect()"]'
          ).disabled = false;

          // Disable message input and send button
          document.getElementById("messageInput").disabled = true;
          document.querySelector(
            'button[onclick="sendMessage()"]'
          ).disabled = true;
        });

        socket.on("connect_error", (err) => {
          console.error("Connection error:", err);
          alert("Connection error: " + err.message);
        });
      }

      function sendMessage() {
        const messageInput = document.getElementById("messageInput");
        const message = messageInput.value;
        if (message) {
          const userId = document.getElementById("userIdInput").value;
          const msgObj = {
            data: message,
            from: userId,
            event: "",
            to: "",
          };
          socket.send(JSON.stringify(msgObj));
          messageInput.value = "";

          // Display the sent message in the messages div
          const messagesDiv = document.getElementById("messages");
          const messageElement = document.createElement("div");
          messageElement.textContent = "You: " + message;
          messagesDiv.appendChild(messageElement);
        }
      }
    </script>
  </body>
</html>
