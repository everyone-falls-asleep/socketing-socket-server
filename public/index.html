<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebSocket Chat Client</title>
    <style>
      #chatBox {
        width: 100%;
        height: 300px;
        border: 1px solid #ccc;
        overflow-y: auto;
        padding: 10px;
        margin-bottom: 10px;
      }
      .message {
        margin: 5px 0;
      }
      .sent {
        text-align: right;
        color: blue;
      }
      .received {
        text-align: left;
        color: green;
      }
    </style>
  </head>
  <body>
    <h1>WebSocket Chat Client</h1>
    <p>Check console for WebSocket events.</p>

    <!-- User ID 입력 필드 -->
    <label for="userIdInput">Your User ID:</label>
    <input type="text" id="userIdInput" placeholder="Enter your user ID" />
    <button onclick="connectWebSocket()">Connect</button>

    <!-- 메시지 입력 필드 -->
    <div id="chatBox"></div>
    <input
      type="text"
      id="toUserInput"
      placeholder="Recipient's User ID"
      disabled
    />
    <input
      type="text"
      id="messageInput"
      placeholder="Type a message"
      disabled
    />
    <button id="sendButton" onclick="sendMessage()" disabled>Send</button>

    <script>
      let socket; // WebSocket 객체를 저장할 변수
      let userId; // 사용자 ID를 저장할 변수

      // WebSocket 서버에 연결
      function connectWebSocket() {
        const userIdInput = document.getElementById("userIdInput");
        userId = userIdInput.value.trim();

        if (!userId) {
          alert("Please enter a valid User ID.");
          return;
        }

        // 현재 브라우저의 URL을 기준으로 WebSocket 주소 생성
        const wsProtocol =
          window.location.protocol === "https:" ? "wss://" : "ws://";
        const wsUrl = `${wsProtocol}${window.location.host}/ws/${userId}`;

        socket = new WebSocket(wsUrl);

        // WebSocket 이벤트 리스너 설정
        socket.addEventListener("open", () => {
          console.log("WebSocket connection established");
          document.getElementById("toUserInput").disabled = false;
          document.getElementById("messageInput").disabled = false;
          document.getElementById("sendButton").disabled = false;
        });

        socket.addEventListener("message", (event) => {
          console.log("Message from server:", event.data);
          const message = JSON.parse(event.data);
          displayMessage(`From ${message.from}: ${message.data}`, "received");
        });

        socket.addEventListener("close", () => {
          console.log("WebSocket connection closed");
          document.getElementById("toUserInput").disabled = true;
          document.getElementById("messageInput").disabled = true;
          document.getElementById("sendButton").disabled = true;
        });

        socket.addEventListener("error", (error) => {
          console.error("WebSocket error:", error);
        });
      }

      // 서버에 메시지 전송
      function sendMessage() {
        const toUserInput = document.getElementById("toUserInput");
        const messageInput = document.getElementById("messageInput");

        const toUser = toUserInput.value.trim();
        const messageText = messageInput.value.trim();

        if (!toUser || !messageText) {
          alert("Please enter both recipient's User ID and a message.");
          return;
        }

        const message = {
          from: userId,
          to: toUser,
          event: "CUSTOM_EVENT",
          data: messageText,
        };

        if (socket && socket.readyState === WebSocket.OPEN) {
          socket.send(JSON.stringify(message));
          displayMessage(`To ${toUser}: ${messageText}`, "sent");
          messageInput.value = "";
        } else {
          console.error("WebSocket is not connected.");
        }
      }

      // 화면에 메시지 표시
      function displayMessage(message, type) {
        const chatBox = document.getElementById("chatBox");
        const messageElement = document.createElement("div");
        messageElement.className = `message ${type}`;
        messageElement.textContent = message;
        chatBox.appendChild(messageElement);
        chatBox.scrollTop = chatBox.scrollHeight; // 스크롤을 맨 아래로
      }
    </script>
  </body>
</html>
